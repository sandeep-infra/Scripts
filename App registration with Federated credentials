Write-Host "Fetching applications with Federated Credentials..." -ForegroundColor Cyan

# Fetch all applications
$apps = Get-MgApplication -All -Property "id,appId,displayName,createdDateTime"

$reportData = [System.Collections.Generic.List[PSObject]]::new()
$appCount = 0

foreach ($app in $apps) {
    try {
        # Get federated identity credentials for this application
        $federatedCreds = Get-MgApplicationFederatedIdentityCredential -ApplicationId $app.Id -ErrorAction SilentlyContinue
        
        if ($federatedCreds.Count -gt 0) {
            $appCount++
            
            foreach ($fedCred in $federatedCreds) {
                $entry = [PSCustomObject]@{
                    ApplicationName = $app.DisplayName
                    ApplicationID = $app.AppId
                    FederatedCredentialName = $fedCred.Name
                    Issuer = $fedCred.Issuer
                    Subject = $fedCred.Subject
                    Audience = ($fedCred.Audiences -join ',')
                    Description = $fedCred.Description
                    CreatedDateTime = $app.CreatedDateTime
                }
                
                $reportData.Add($entry)
            }
            
            Write-Host "âœ“ Found $($federatedCreds.Count) federated credential(s) for: $($app.DisplayName)" -ForegroundColor Green
        }
    }
    catch {
        # Continue silently for apps without federated credentials
        continue
    }
}

# Display summary
Write-Host "`nâœ… Summary: Found $appCount applications with $($reportData.Count) federated credentials total." -ForegroundColor Green

if ($reportData.Count -gt 0) {
    # Group by application to show summary
    $uniqueApps = $reportData | Group-Object ApplicationID | ForEach-Object {
        [PSCustomObject]@{
            ApplicationName = $_.Group[0].ApplicationName
            ApplicationID = $_.Group[0].ApplicationID
            FederatedCredentialCount = $_.Count
            Issuers = ($_.Group.Issuer | Sort-Object -Unique) -join '; '
        }
    }
    
    Write-Output "`nApplications with Federated Credentials:"
    $uniqueApps | Format-Table ApplicationName, ApplicationID, FederatedCredentialCount, Issuers -AutoSize
    
    # Export detailed report
    $reportData | Export-Csv -Path "C:\Users\sande\OneDrive\data-inout-PS\AppsWithFederatedCredentials_Detailed.csv" -NoTypeInformation
    Write-Output "ðŸ“„ Detailed report exported to: AppsWithFederatedCredentials_Detailed.csv" -ForegroundColor Yellow
}
